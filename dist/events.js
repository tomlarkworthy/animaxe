/// <reference path="../types/canvas.d.ts" />
var Rx = require("rx");
var Ax = require("./animaxe");
var Parameter = require("./parameter");
/**
 * Convert animation coordinates (e.g. a coordinate of moveTo) to global canvas coordinates, cooeffecients are:
 * [ a c e
 *   b d f
 *   0 0 1 ]
 * This is basically just a matrix multiplication of the context.transform
 */
function animation2Canvas(canvas, a, b, c, d, e, f) {
    var x = a * canvas[0] + c * canvas[1] + e;
    var y = b * canvas[0] + d * canvas[1] + f;
    return [x, y];
}
exports.animation2Canvas = animation2Canvas;
/**
 * Convert canvas coordinates (e.g. mouse position on canvas) to local animation coordinates, cooeffecients are:
 * [ a c e
 *   b d f
 *   0 0 1 ]
 *  This is basically just an inverse matrix multiplication of the context.transform
 */
function canvas2Animation(canvasCoord, a, b, c, d, e, f) {
    // see http://stackoverflow.com/questions/10892267/html5-canvas-transformation-algorithm-finding-object-coordinates-after-applyin
    var M = (a * d - b * c);
    return animation2Canvas(canvasCoord, d / M, -b / M, -c / M, a / M, (c * f - d * e) / M, (b * e - a * f) / M);
}
exports.canvas2Animation = canvas2Animation;
function canvas2AnimationUsingContext(canvasCoord, ctx) {
    var tx = ctx.getTransform();
    return canvas2Animation(canvasCoord, tx[0], tx[1], tx[3], tx[4], tx[6], tx[7]);
}
/**
 * Objects of this type are passed through the tick pipeline, and encapsulate potentially many concurrent system events
 * originating from the canvas DOM. These have to be intepreted by UI components to see if they hit
 */
var Events = (function () {
    function Events() {
        this.mousedowns = [];
        this.mouseups = [];
        this.mousemoves = [];
        this.mouseenters = [];
        this.mouseleaves = [];
    }
    //onmouseover: Ax.Point[] = []; to implement these we need to think about heirarchy in components
    //onmouseout: Ax.Point[] = [];
    /**
     * clear all the events, done by animator at the end of a tick
     */
    Events.prototype.clear = function () {
        this.mousedowns = [];
        this.mouseups = [];
        this.mousemoves = [];
        this.mouseenters = [];
        this.mouseleaves = [];
    };
    return Events;
})();
exports.Events = Events;
var ComponentMouseState = (function () {
    function ComponentMouseState() {
        this.mousedown = new Rx.Subject();
        this.mouseup = new Rx.Subject();
        this.mousemove = new Rx.Subject();
        this.mouseenter = new Rx.Subject();
        this.mouseleave = new Rx.Subject();
    }
    ComponentMouseState.prototype.isMouseOver = function () {
        var toggle = Rx.Observable.merge([
            this.mouseenter.map(function (x) { return true; }),
            this.mouseleave.map(function (x) { return false; })]);
        return Parameter.updateFrom(false, toggle);
    };
    ComponentMouseState.prototype.isMouseDown = function () {
        var mouseDown = Rx.Observable.merge([
            this.mousedown.map(function (x) { return true; }),
            this.mouseup.map(function (x) { return false; }),
            this.mouseleave.map(function (x) { return false; })]);
        return Parameter.updateFrom(false, mouseDown);
    };
    return ComponentMouseState;
})();
exports.ComponentMouseState = ComponentMouseState;
/**
 * returns an animation that can be pipelined after a path, which used canvas isPointInPath to detect if a mouse event has
 * occured over the source animation
 */
function ComponentMouseEventHandler(events) {
    return Ax.draw(function () {
        var mouseIsOver = false;
        return function (tick) {
            function processSystemMouseEvents(sourceEvents, componentEventStream) {
                sourceEvents.forEach(function (evt) {
                    if (componentEventStream.hasObservers() && tick.ctx.isPointInPath(evt[0], evt[1])) {
                        // we have to figure out the global position of this component, so the x and y
                        // have to go backward through the transform matrix
                        var localEvent = new AxMouseEvent(events.source, canvas2AnimationUsingContext(evt, tick.ctx), evt);
                        componentEventStream.onNext(localEvent);
                    }
                });
            }
            function processSystemMouseMoveEvents(sourceMoveEvents, mousemoveStream, mouseenterStream, mouseleaveStream) {
                sourceMoveEvents.forEach(function (evt) {
                    if (mousemoveStream.hasObservers() || mouseenterStream.hasObservers() || mouseleaveStream.hasObservers()) {
                        var pointInPath = tick.ctx.isPointInPath(evt[0], evt[1]);
                        var localEvent = new AxMouseEvent(events.source, canvas2AnimationUsingContext(evt, tick.ctx), evt);
                        if (mouseenterStream.hasObservers() && pointInPath && !mouseIsOver) {
                            mouseenterStream.onNext(localEvent);
                        }
                        if (mousemoveStream.hasObservers() && pointInPath) {
                            mousemoveStream.onNext(localEvent);
                        }
                        if (mouseleaveStream.hasObservers() && !pointInPath && mouseIsOver) {
                            mouseleaveStream.onNext(localEvent);
                        }
                        mouseIsOver = pointInPath;
                    }
                });
            }
            processSystemMouseEvents(tick.events.mousedowns, events.mousedown);
            processSystemMouseEvents(tick.events.mouseups, events.mouseup);
            processSystemMouseMoveEvents(tick.events.mousemoves, events.mousemove, events.mouseenter, events.mouseleave);
        };
    });
}
exports.ComponentMouseEventHandler = ComponentMouseEventHandler;
/**
 * returns an animation that can be pipelined anywhere, which listens for global mouse events over the entire canvas
 * AxMouseEvent raised globally have a null source field, and identical global and local coordinates
 */
function CanvasMouseEventHandler(events) {
    return Ax.draw(function () {
        return function (tick) {
            function processSystemMouseEvents(sourceEvents, componentEventStream) {
                sourceEvents.forEach(function (evt) {
                    if (componentEventStream.hasObservers()) {
                        componentEventStream.onNext(new AxMouseEvent(null, evt, evt));
                    }
                });
            }
            processSystemMouseEvents(tick.events.mousedowns, events.mousedown);
            processSystemMouseEvents(tick.events.mouseups, events.mouseup);
            processSystemMouseEvents(tick.events.mousemoves, events.mousemove);
            processSystemMouseEvents(tick.events.mouseenters, events.mouseenter);
            processSystemMouseEvents(tick.events.mouseleaves, events.mouseleave);
        };
    });
}
exports.CanvasMouseEventHandler = CanvasMouseEventHandler;
var AxMouseEvent = (function () {
    function AxMouseEvent(source, animationCoord, canvasCoord) {
        this.source = source;
        this.animationCoord = animationCoord;
        this.canvasCoord = canvasCoord;
    }
    return AxMouseEvent;
})();
exports.AxMouseEvent = AxMouseEvent;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50cy50cyJdLCJuYW1lcyI6WyJhbmltYXRpb24yQ2FudmFzIiwiY2FudmFzMkFuaW1hdGlvbiIsImNhbnZhczJBbmltYXRpb25Vc2luZ0NvbnRleHQiLCJFdmVudHMiLCJFdmVudHMuY29uc3RydWN0b3IiLCJFdmVudHMuY2xlYXIiLCJDb21wb25lbnRNb3VzZVN0YXRlIiwiQ29tcG9uZW50TW91c2VTdGF0ZS5jb25zdHJ1Y3RvciIsIkNvbXBvbmVudE1vdXNlU3RhdGUuaXNNb3VzZU92ZXIiLCJDb21wb25lbnRNb3VzZVN0YXRlLmlzTW91c2VEb3duIiwiQ29tcG9uZW50TW91c2VFdmVudEhhbmRsZXIiLCJDb21wb25lbnRNb3VzZUV2ZW50SGFuZGxlci5wcm9jZXNzU3lzdGVtTW91c2VFdmVudHMiLCJDb21wb25lbnRNb3VzZUV2ZW50SGFuZGxlci5wcm9jZXNzU3lzdGVtTW91c2VNb3ZlRXZlbnRzIiwiQ2FudmFzTW91c2VFdmVudEhhbmRsZXIiLCJDYW52YXNNb3VzZUV2ZW50SGFuZGxlci5wcm9jZXNzU3lzdGVtTW91c2VFdmVudHMiLCJBeE1vdXNlRXZlbnQiLCJBeE1vdXNlRXZlbnQuY29uc3RydWN0b3IiXSwibWFwcGluZ3MiOiJBQUFBLDZDQUE2QztBQUM3QyxJQUFPLEVBQUUsV0FBVyxJQUFJLENBQUMsQ0FBQztBQUMxQixJQUFPLEVBQUUsV0FBVyxXQUFXLENBQUMsQ0FBQztBQUNqQyxJQUFPLFNBQVMsV0FBWSxhQUFhLENBQUMsQ0FBQztBQUkzQzs7Ozs7O0dBTUc7QUFDSCwwQkFBa0MsTUFBZ0IsRUFBQyxDQUFRLEVBQUUsQ0FBUSxFQUFDLENBQVEsRUFBQyxDQUFRLEVBQUMsQ0FBUSxFQUFDLENBQVE7SUFDckdBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLEdBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO0lBQ3RDQSxJ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QUFTQSxDQUFDQSxDQUFDQTtZQUNuRUEsd0JBQXdCQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxRQUFRQSxFQUFFQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtZQUMvREEsd0JBQXdCQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxNQUFNQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQTtZQUNuRUEsd0JBQXdCQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxXQUFXQSxFQUFFQSxNQUFNQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtZQUNyRUEsd0JBQXdCQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxXQUFXQSxFQUFFQSxNQUFNQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUN6RUEsQ0FBQ0EsQ0FBQUE7SUFDTEEsQ0FBQ0EsQ0FDSkEsQ0FBQUE7QUFDTEEsQ0FBQ0E7QUF6QmUsK0JBQXVCLDBCQXlCdEMsQ0FBQTtBQUVEO0lBQ0lFLHNCQUFtQkEsTUFBV0EsRUFBU0EsY0FBd0JBLEVBQVNBLFdBQXFCQTtRQUExRUMsV0FBTUEsR0FBTkEsTUFBTUEsQ0FBS0E7UUFBU0EsbUJBQWNBLEdBQWRBLGNBQWNBLENBQVVBO1FBQVNBLGdCQUFXQSxHQUFYQSxXQUFXQSxDQUFVQTtJQUFHQSxDQUFDQTtJQUNyR0QsbUJBQUNBO0FBQURBLENBRkEsQUFFQ0EsSUFBQTtBQUZZLG9CQUFZLGVBRXhCLENBQUEiLCJmaWxlIjoiZXZlbnRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL3R5cGVzL2NhbnZhcy5kLnRzXCIgLz5cbmltcG9ydCBSeCA9IHJlcXVpcmUoXCJyeFwiKTtcbmltcG9ydCBBeCA9IHJlcXVpcmUoXCIuL2FuaW1heGVcIik7XG5pbXBvcnQgUGFyYW1ldGVyID0gcmVxdWlyZSAoXCIuL3BhcmFtZXRlclwiKTtcblxuZXhwb3J0IHR5cGUgU3lzdGVtTW91c2VFdmVudHMgPSBBeC5Qb2ludFtdO1xuXG4vKipcbiAqIENvbnZlcnQgYW5pbWF0aW9uIGNvb3JkaW5hdGVzIChlLmcuIGEgY29vcmRpbmF0ZSBvZiBtb3ZlVG8pIHRvIGdsb2JhbCBjYW52YXMgY29vcmRpbmF0ZXMsIGNvb2VmZmVjaWVudHMgYXJlOlxuICogWyBhIGMgZVxuICogICBiIGQgZlxuICogICAwIDAgMSBdXG4gKiBUaGlzIGlzIGJhc2ljYWxseSBqdXN0IGEgbWF0cml4IG11bHRpcGxpY2F0aW9uIG9mIHRoZSBjb250ZXh0LnRyYW5zZm9ybVxuICovXG5leHBvcnQgZnVuY3Rpb24gYW5pbWF0aW9uMkNhbnZhcyAoY2FudmFzOiBBeC5Qb2ludCxhOm51bWJlciwgYjpudW1iZXIsYzpudW1iZXIsZDpudW1iZXIsZTpudW1iZXIsZjpudW1iZXIpOiBBeC5Qb2ludCB7XG4gICAgdmFyIHggPSBhKmNhbnZhc1swXSArIGMqY2FudmFzWzFdICsgZTtcbiAgICB2YXIgeSA9IGIqY2FudmFzWzBdICsgZCpjYW52YXNbMV0gKyBmO1xuICAgIHJldHVybiBbeCx5XTtcbn1cbi8qKlxuICogQ29udmVydCBjYW52YXMgY29vcmRpbmF0ZXMgKGUuZy4gbW91c2UgcG9zaXRpb24gb24gY2FudmFzKSB0byBsb2NhbCBhbmltYXRpb24gY29vcmRpbmF0ZXMsIGNvb2VmZmVjaWVudHMgYXJlOlxuICogWyBhIGMgZVxuICogICBiIGQgZlxuICogICAwIDAgMSBdXG4gKiAgVGhpcyBpcyBiYXNpY2FsbHkganVzdCBhbiBpbnZlcnNlIG1hdHJpeCBtdWx0aXBsaWNhdGlvbiBvZiB0aGUgY29udGV4dC50cmFuc2Zvcm1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNhbnZhczJBbmltYXRpb24gKGNhbnZhc0Nvb3JkOiBBeC5Qb2ludCxhOm51bWJlciwgYjpudW1iZXIsYzpudW1iZXIsZDpudW1iZXIsZTpudW1iZXIsZjpudW1iZXIpOiBBeC5Qb2ludCB7XG4gICAgLy8gc2VlIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTA4OTIyNjcvaHRtbDUtY2FudmFzLXRyYW5zZm9ybWF0aW9uLWFsZ29yaXRobS1maW5kaW5nLW9iamVjdC1jb29yZGluYXRlcy1hZnRlci1hcHBseWluXG4gICAgdmFyIE0gPSAoYSpkIC0gYipjKTtcbiAgICByZXR1cm4gYW5pbWF0aW9uMkNhbnZhcyhjYW52YXNDb29yZCwgZC9NLCAtYi9NLCAtYy9NLCBhL00sIChjKmYgLSBkKmUpL00sIChiKmUgLSBhKmYpL00pXG59XG5cbmZ1bmN0aW9uIGNhbnZhczJBbmltYXRpb25Vc2luZ0NvbnRleHQgKGNhbnZhc0Nvb3JkOiBBeC5Qb2ludCwgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQpOiBBeC5Qb2ludCB7XG4gICAgdmFyIHR4ID0gY3R4LmdldFRyYW5zZm9ybSgpO1xuICAgIHJldHVybiBjYW52YXMyQW5pbWF0aW9uKGNhbnZhc0Nvb3JkLCB0eFswXSwgdHhbMV0sIHR4WzNdLCB0eFs0XSwgdHhbNl0sIHR4WzddKVxufVxuLyoqXG4gKiBPYmplY3RzIG9mIHRoaXMgdHlwZSBhcmUgcGFzc2VkIHRocm91Z2ggdGhlIHRpY2sgcGlwZWxpbmUsIGFuZCBlbmNhcHN1bGF0ZSBwb3RlbnRpYWxseSBtYW55IGNvbmN1cnJlbnQgc3lzdGVtIGV2ZW50c1xuICogb3JpZ2luYXRpbmcgZnJvbSB0aGUgY2FudmFzIERPTS4gVGhlc2UgaGF2ZSB0byBiZSBpbnRlcHJldGVkIGJ5IFVJIGNvbXBvbmVudHMgdG8gc2VlIGlmIHRoZXkgaGl0XG4gKi9cbmV4cG9ydCBjbGFzcyBFdmVudHMge1xuICAgIG1vdXNlZG93bnM6IFN5c3RlbU1vdXNlRXZlbnRzID0gW107XG4gICAgbW91c2V1cHM6ICAgU3lzdGVtTW91c2VFdmVudHMgPSBbXTtcbiAgICBtb3VzZW1vdmVzOiBTeXN0ZW1Nb3VzZUV2ZW50cyA9IFtdO1xuICAgIG1vdXNlZW50ZXJzOiBTeXN0ZW1Nb3VzZUV2ZW50cyA9IFtdO1xuICAgIG1vdXNlbGVhdmVzOiBTeXN0ZW1Nb3VzZUV2ZW50cyA9IFtdO1xuICAgIC8vb25tb3VzZW92ZXI6IEF4LlBvaW50W10gPSBbXTsgdG8gaW1wbGVtZW50IHRoZXNlIHdlIG5lZWQgdG8gdGhpbmsgYWJvdXQgaGVpcmFyY2h5IGluIGNvbXBvbmVudHNcbiAgICAvL29ubW91c2VvdXQ6IEF4LlBvaW50W10gPSBbXTtcblxuICAgIC8qKlxuICAgICAqIGNsZWFyIGFsbCB0aGUgZXZlbnRzLCBkb25lIGJ5IGFuaW1hdG9yIGF0IHRoZSBlbmQgb2YgYSB0aWNrXG4gICAgICovXG4gICAgY2xlYXIoKSB7XG4gICAgICAgIHRoaXMubW91c2Vkb3ducyA9IFtdO1xuICAgICAgICB0aGlzLm1vdXNldXBzICAgPSBbXTtcbiAgICAgICAgdGhpcy5tb3VzZW1vdmVzID0gW107XG4gICAgICAgIHRoaXMubW91c2VlbnRlcnMgPSBbXTtcbiAgICAgICAgdGhpcy5tb3VzZWxlYXZlcyA9IFtdO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIENvbXBvbmVudE1vdXNlU3RhdGUge1xuICAgIG1vdXNlZG93biAgICA9IG5ldyBSeC5TdWJqZWN0PEF4TW91c2VFdmVudD4oKTtcbiAgICBtb3VzZXVwICAgICAgPSBuZXcgUnguU3ViamVjdDxBeE1vdXNlRXZlbnQ+KCk7XG4gICAgbW91c2Vtb3ZlICAgID0gbmV3IFJ4LlN1YmplY3Q8QXhNb3VzZUV2ZW50PigpO1xuICAgIG1vdXNlZW50ZXIgICA9IG5ldyBSeC5TdWJqZWN0PEF4TW91c2VFdmVudD4oKTtcbiAgICBtb3VzZWxlYXZlICAgPSBuZXcgUnguU3ViamVjdDxBeE1vdXNlRXZlbnQ+KCk7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIG5lZWRzIHRvIGJlIHNldCBhZnRlciBjb25zdHJ1Y3Rpb25cbiAgICAgKi9cbiAgICBzb3VyY2U6IGFueTtcblxuICAgIGlzTW91c2VPdmVyKCk6IEF4LlBhcmFtZXRlcjxib29sZWFuPiB7XG4gICAgICAgIHZhciB0b2dnbGU6IFJ4Lk9ic2VydmFibGU8Ym9vbGVhbj4gPVxuICAgICAgICAgICAgUnguT2JzZXJ2YWJsZS5tZXJnZShbXG4gICAgICAgICAgICAgICAgdGhpcy5tb3VzZWVudGVyLm1hcCgoeCkgPT4gdHJ1ZSksXG4gICAgICAgICAgICAgICAgdGhpcy5tb3VzZWxlYXZlLm1hcCgoeCkgPT4gZmFsc2UpXSk7XG4gICAgICAgIHJldHVybiBQYXJhbWV0ZXIudXBkYXRlRnJvbShmYWxzZSwgdG9nZ2xlKTtcbiAgICB9XG5cbiAgICBpc01vdXNlRG93bigpOiBBeC5QYXJhbWV0ZXI8Ym9vbGVhbj4ge1xuICAgICAgICB2YXIgbW91c2VEb3duOiBSeC5PYnNlcnZhYmxlPGJvb2xlYW4+ID1cbiAgICAgICAgICAgIFJ4Lk9ic2VydmFibGUubWVyZ2UoW1xuICAgICAgICAgICAgICAgIHRoaXMubW91c2Vkb3duLm1hcCgoeCkgID0+IHRydWUpLFxuICAgICAgICAgICAgICAgIHRoaXMubW91c2V1cC5tYXAoKHgpICAgID0+IGZhbHNlKSxcbiAgICAgICAgICAgICAgICB0aGlzLm1vdXNlbGVhdmUubWFwKCh4KSA9PiBmYWxzZSldKTtcbiAgICAgICAgcmV0dXJuIFBhcmFtZXRlci51cGRhdGVGcm9tKGZhbHNlLCBtb3VzZURvd24pO1xuICAgIH1cbn1cblxuLyoqXG4gKiByZXR1cm5zIGFuIGFuaW1hdGlvbiB0aGF0IGNhbiBiZSBwaXBlbGluZWQgYWZ0ZXIgYSBwYXRoLCB3aGljaCB1c2VkIGNhbnZhcyBpc1BvaW50SW5QYXRoIHRvIGRldGVjdCBpZiBhIG1vdXNlIGV2ZW50IGhhc1xuICogb2NjdXJlZCBvdmVyIHRoZSBzb3VyY2UgYW5pbWF0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBDb21wb25lbnRNb3VzZUV2ZW50SGFuZGxlcihldmVudHM6IENvbXBvbmVudE1vdXNlU3RhdGUpOiBBeC5BbmltYXRpb24ge1xuICAgIHJldHVybiBBeC5kcmF3KFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICB2YXIgbW91c2VJc092ZXIgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybiAodGljazogQXguVGljaykgPT4ge1xuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NTeXN0ZW1Nb3VzZUV2ZW50cyhcbiAgICAgICAgICAgICAgICAgICAgc291cmNlRXZlbnRzOiBTeXN0ZW1Nb3VzZUV2ZW50cyxcbiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RXZlbnRTdHJlYW06IFJ4LlN1YmplY3Q8QXhNb3VzZUV2ZW50PlxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBzb3VyY2VFdmVudHMuZm9yRWFjaChcbiAgICAgICAgICAgICAgICAgICAgICAgIChldnQ6IEF4LlBvaW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudEV2ZW50U3RyZWFtLmhhc09ic2VydmVycygpICYmIHRpY2suY3R4LmlzUG9pbnRJblBhdGgoZXZ0WzBdLCBldnRbMV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGhhdmUgdG8gZmlndXJlIG91dCB0aGUgZ2xvYmFsIHBvc2l0aW9uIG9mIHRoaXMgY29tcG9uZW50LCBzbyB0aGUgeCBhbmQgeVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBoYXZlIHRvIGdvIGJhY2t3YXJkIHRocm91Z2ggdGhlIHRyYW5zZm9ybSBtYXRyaXhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvY2FsRXZlbnQgPSBuZXcgQXhNb3VzZUV2ZW50KGV2ZW50cy5zb3VyY2UsIGNhbnZhczJBbmltYXRpb25Vc2luZ0NvbnRleHQoZXZ0LCB0aWNrLmN0eCksIGV2dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEV2ZW50U3RyZWFtLm9uTmV4dChsb2NhbEV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBwcm9jZXNzU3lzdGVtTW91c2VNb3ZlRXZlbnRzKFxuICAgICAgICAgICAgICAgICAgICBzb3VyY2VNb3ZlRXZlbnRzOiBTeXN0ZW1Nb3VzZUV2ZW50cyxcbiAgICAgICAgICAgICAgICAgICAgbW91c2Vtb3ZlU3RyZWFtOiBSeC5TdWJqZWN0PEF4TW91c2VFdmVudD4sXG4gICAgICAgICAgICAgICAgICAgIG1vdXNlZW50ZXJTdHJlYW06IFJ4LlN1YmplY3Q8QXhNb3VzZUV2ZW50PixcbiAgICAgICAgICAgICAgICAgICAgbW91c2VsZWF2ZVN0cmVhbTogUnguU3ViamVjdDxBeE1vdXNlRXZlbnQ+XG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZU1vdmVFdmVudHMuZm9yRWFjaChcbiAgICAgICAgICAgICAgICAgICAgICAgIChldnQ6IEF4LlBvaW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vdXNlbW92ZVN0cmVhbS5oYXNPYnNlcnZlcnMoKSB8fCBtb3VzZWVudGVyU3RyZWFtLmhhc09ic2VydmVycygpIHx8IG1vdXNlbGVhdmVTdHJlYW0uaGFzT2JzZXJ2ZXJzKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBvaW50SW5QYXRoID0gdGljay5jdHguaXNQb2ludEluUGF0aChldnRbMF0sIGV2dFsxXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbEV2ZW50ID0gbmV3IEF4TW91c2VFdmVudChldmVudHMuc291cmNlLCBjYW52YXMyQW5pbWF0aW9uVXNpbmdDb250ZXh0KGV2dCwgdGljay5jdHgpLCBldnQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZWVudGVyU3RyZWFtLmhhc09ic2VydmVycygpICYmIHBvaW50SW5QYXRoICYmICFtb3VzZUlzT3Zlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW91c2VlbnRlclN0cmVhbS5vbk5leHQobG9jYWxFdmVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vdXNlbW92ZVN0cmVhbS5oYXNPYnNlcnZlcnMoKSAmJiBwb2ludEluUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW91c2Vtb3ZlU3RyZWFtLm9uTmV4dChsb2NhbEV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZWxlYXZlU3RyZWFtLmhhc09ic2VydmVycygpICYmICFwb2ludEluUGF0aCAmJiBtb3VzZUlzT3Zlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW91c2VsZWF2ZVN0cmVhbS5vbk5leHQobG9jYWxFdmVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VzZUlzT3ZlciA9IHBvaW50SW5QYXRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHByb2Nlc3NTeXN0ZW1Nb3VzZUV2ZW50cyh0aWNrLmV2ZW50cy5tb3VzZWRvd25zLCBldmVudHMubW91c2Vkb3duKTtcbiAgICAgICAgICAgICAgICBwcm9jZXNzU3lzdGVtTW91c2VFdmVudHModGljay5ldmVudHMubW91c2V1cHMsIGV2ZW50cy5tb3VzZXVwKTtcbiAgICAgICAgICAgICAgICBwcm9jZXNzU3lzdGVtTW91c2VNb3ZlRXZlbnRzKHRpY2suZXZlbnRzLm1vdXNlbW92ZXMsIGV2ZW50cy5tb3VzZW1vdmUsIGV2ZW50cy5tb3VzZWVudGVyLCBldmVudHMubW91c2VsZWF2ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICApXG59XG5cbi8qKlxuICogcmV0dXJucyBhbiBhbmltYXRpb24gdGhhdCBjYW4gYmUgcGlwZWxpbmVkIGFueXdoZXJlLCB3aGljaCBsaXN0ZW5zIGZvciBnbG9iYWwgbW91c2UgZXZlbnRzIG92ZXIgdGhlIGVudGlyZSBjYW52YXNcbiAqIEF4TW91c2VFdmVudCByYWlzZWQgZ2xvYmFsbHkgaGF2ZSBhIG51bGwgc291cmNlIGZpZWxkLCBhbmQgaWRlbnRpY2FsIGdsb2JhbCBhbmQgbG9jYWwgY29vcmRpbmF0ZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIENhbnZhc01vdXNlRXZlbnRIYW5kbGVyKGV2ZW50czogQ29tcG9uZW50TW91c2VTdGF0ZSk6IEF4LkFuaW1hdGlvbiB7XG4gICAgcmV0dXJuIEF4LmRyYXcoXG4gICAgICAgICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiAodGljazogQXguVGljaykgPT4ge1xuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NTeXN0ZW1Nb3VzZUV2ZW50cyhcbiAgICAgICAgICAgICAgICAgICAgc291cmNlRXZlbnRzOiBTeXN0ZW1Nb3VzZUV2ZW50cyxcbiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RXZlbnRTdHJlYW06IFJ4LlN1YmplY3Q8QXhNb3VzZUV2ZW50PlxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBzb3VyY2VFdmVudHMuZm9yRWFjaChcbiAgICAgICAgICAgICAgICAgICAgICAgIChldnQ6IEF4LlBvaW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudEV2ZW50U3RyZWFtLmhhc09ic2VydmVycygpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEV2ZW50U3RyZWFtLm9uTmV4dChuZXcgQXhNb3VzZUV2ZW50KG51bGwsIGV2dCwgZXZ0KSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcHJvY2Vzc1N5c3RlbU1vdXNlRXZlbnRzKHRpY2suZXZlbnRzLm1vdXNlZG93bnMsIGV2ZW50cy5tb3VzZWRvd24pO1xuICAgICAgICAgICAgICAgIHByb2Nlc3NTeXN0ZW1Nb3VzZUV2ZW50cyh0aWNrLmV2ZW50cy5tb3VzZXVwcywgZXZlbnRzLm1vdXNldXApO1xuICAgICAgICAgICAgICAgIHByb2Nlc3NTeXN0ZW1Nb3VzZUV2ZW50cyh0aWNrLmV2ZW50cy5tb3VzZW1vdmVzLCBldmVudHMubW91c2Vtb3ZlKTtcbiAgICAgICAgICAgICAgICBwcm9jZXNzU3lzdGVtTW91c2VFdmVudHModGljay5ldmVudHMubW91c2VlbnRlcnMsIGV2ZW50cy5tb3VzZWVudGVyKTtcbiAgICAgICAgICAgICAgICBwcm9jZXNzU3lzdGVtTW91c2VFdmVudHModGljay5ldmVudHMubW91c2VsZWF2ZXMsIGV2ZW50cy5tb3VzZWxlYXZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIClcbn1cblxuZXhwb3J0IGNsYXNzIEF4TW91c2VFdmVudCB7XG4gICAgY29uc3RydWN0b3IocHVibGljIHNvdXJjZTogYW55LCBwdWJsaWMgYW5pbWF0aW9uQ29vcmQ6IEF4LlBvaW50LCBwdWJsaWMgY2FudmFzQ29vcmQ6IEF4LlBvaW50KSB7fVxufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
