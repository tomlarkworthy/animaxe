/// <reference path="../types/canvas.d.ts" />
var Rx = require("rx");
var Ax = require("./animaxe");
var Parameter = require("./parameter");
Ax.DEBUG = true;
/**
 * Convert animation coordinates (e.g. a coordinate of moveTo) to global canvas coordinates, cooeffecients are:
 * [ a c e
 *   b d f
 *   0 0 1 ]
 * This is basically just a matrix multiplication of the context.transform
 */
function animation2Canvas(canvas, a, b, c, d, e, f) {
    var x = a * canvas[0] + c * canvas[1] + e;
    var y = b * canvas[0] + d * canvas[1] + f;
    return [x, y];
}
exports.animation2Canvas = animation2Canvas;
/**
 * Convert canvas coordinates (e.g. mouse position on canvas) to local animation coordinates, cooeffecients are:
 * [ a c e
 *   b d f
 *   0 0 1 ]
 *  This is basically just an inverse matrix multiplication of the context.transform
 */
function canvas2Animation(canvasCoord, a, b, c, d, e, f) {
    // see http://stackoverflow.com/questions/10892267/html5-canvas-transformation-algorithm-finding-object-coordinates-after-applyin
    var M = (a * d - b * c);
    return animation2Canvas(canvasCoord, d / M, -b / M, -c / M, a / M, (c * f - d * e) / M, (b * e - a * f) / M);
}
exports.canvas2Animation = canvas2Animation;
function canvas2AnimationUsingContext(canvasCoord, ctx) {
    var tx = ctx.getTransform();
    return canvas2Animation(canvasCoord, tx[0], tx[1], tx[3], tx[4], tx[6], tx[7]);
}
/**
 * Objects of this type are passed through the tick pipeline, and encapsulate potentially many concurrent system events
 * originating from the canvas DOM. These have to be intepreted by UI components to see if they hit
 */
var Events = (function () {
    function Events() {
        this.mousedowns = [];
        this.mouseups = [];
        this.mousemoves = [];
        this.mouseenters = [];
        this.mouseleaves = [];
    }
    //onmouseover: Ax.Point[] = []; to implement these we need to think about heirarchy in components
    //onmouseout: Ax.Point[] = [];
    /**
     * clear all the events, done by animator at the end of a tick
     */
    Events.prototype.clear = function () {
        this.mousedowns = [];
        this.mouseups = [];
        this.mousemoves = [];
        this.mouseenters = [];
        this.mouseleaves = [];
    };
    return Events;
})();
exports.Events = Events;
var ComponentMouseEvents = (function () {
    function ComponentMouseEvents(source) {
        this.source = source;
        this.mousedown = new Rx.Subject();
        this.mouseup = new Rx.Subject();
        this.mousemove = new Rx.Subject();
        this.mouseenter = new Rx.Subject();
        this.mouseleave = new Rx.Subject();
    }
    ComponentMouseEvents.prototype.isMouseOver = function () {
        var toggle = Rx.Observable.merge([
            this.mouseenter.map(function (x) { return true; }),
            this.mouseleave.map(function (x) { return false; })]);
        return Parameter.updateFrom(false, toggle);
    };
    ComponentMouseEvents.prototype.isMouseDown = function () {
        var mouseDown = Rx.Observable.merge([
            this.mousedown.map(function (x) { return true; }),
            this.mouseup.map(function (x) { return false; }),
            this.mouseleave.map(function (x) { return false; })]);
        return Parameter.updateFrom(false, mouseDown);
    };
    return ComponentMouseEvents;
})();
exports.ComponentMouseEvents = ComponentMouseEvents;
/**
 * returns an animation that can be pipelined after a path, which used canvas isPointInPath to detect if a mouse event has
 * occured over the source animation
 */
function ComponentMouseEventHandler(events) {
    return Ax.draw(function () {
        var mouseIsOver = false;
        return function (tick) {
            function processSystemMouseEvents(sourceEvents, componentEventStream) {
                sourceEvents.forEach(function (evt) {
                    if (componentEventStream.hasObservers() && tick.ctx.isPointInPath(evt[0], evt[1])) {
                        // we have to figure out the global position of this component, so the x and y
                        // have to go backward through the transform matrix
                        var localEvent = new AxMouseEvent(events.source, canvas2AnimationUsingContext(evt, tick.ctx), evt);
                        componentEventStream.onNext(localEvent);
                    }
                });
            }
            function processSystemMouseMoveEvents(sourceMoveEvents, mousemoveStream, mouseenterStream, mouseleaveStream) {
                sourceMoveEvents.forEach(function (evt) {
                    if (mousemoveStream.hasObservers() || mouseenterStream.hasObservers() || mouseleaveStream.hasObservers()) {
                        var pointInPath = tick.ctx.isPointInPath(evt[0], evt[1]);
                        var localEvent = new AxMouseEvent(events.source, canvas2AnimationUsingContext(evt, tick.ctx), evt);
                        if (mouseenterStream.hasObservers() && pointInPath && !mouseIsOver) {
                            mouseenterStream.onNext(localEvent);
                        }
                        if (mousemoveStream.hasObservers() && pointInPath) {
                            mousemoveStream.onNext(localEvent);
                        }
                        if (mouseleaveStream.hasObservers() && !pointInPath && mouseIsOver) {
                            mouseleaveStream.onNext(localEvent);
                        }
                        mouseIsOver = pointInPath;
                    }
                });
            }
            processSystemMouseEvents(tick.events.mousedowns, events.mousedown);
            processSystemMouseEvents(tick.events.mouseups, events.mouseup);
            processSystemMouseMoveEvents(tick.events.mousemoves, events.mousemove, events.mouseenter, events.mouseleave);
        };
    });
}
exports.ComponentMouseEventHandler = ComponentMouseEventHandler;
var AxMouseEvent = (function () {
    function AxMouseEvent(source, animationCoord, canvasCoord) {
        this.source = source;
        this.animationCoord = animationCoord;
        this.canvasCoord = canvasCoord;
    }
    return AxMouseEvent;
})();
exports.AxMouseEvent = AxMouseEvent;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50cy50cyJdLCJuYW1lcyI6WyJhbmltYXRpb24yQ2FudmFzIiwiY2FudmFzMkFuaW1hdGlvbiIsImNhbnZhczJBbmltYXRpb25Vc2luZ0NvbnRleHQiLCJFdmVudHMiLCJFdmVudHMuY29uc3RydWN0b3IiLCJFdmVudHMuY2xlYXIiLCJDb21wb25lbnRNb3VzZUV2ZW50cyIsIkNvbXBvbmVudE1vdXNlRXZlbnRzLmNvbnN0cnVjdG9yIiwiQ29tcG9uZW50TW91c2VFdmVudHMuaXNNb3VzZU92ZXIiLCJDb21wb25lbnRNb3VzZUV2ZW50cy5pc01vdXNlRG93biIsIkNvbXBvbmVudE1vdXNlRXZlbnRIYW5kbGVyIiwiQ29tcG9uZW50TW91c2VFdmVudEhhbmRsZXIucHJvY2Vzc1N5c3RlbU1vdXNlRXZlbnRzIiwiQ29tcG9uZW50TW91c2VFdmVudEhhbmRsZXIucHJvY2Vzc1N5c3RlbU1vdXNlTW92ZUV2ZW50cyIsIkF4TW91c2VFdmVudCIsIkF4TW91c2VFdmVudC5jb25zdHJ1Y3RvciJdLCJtYXBwaW5ncyI6IkFBQUEsNkNBQTZDO0FBQzdDLElBQU8sRUFBRSxXQUFXLElBQUksQ0FBQyxDQUFDO0FBQzFCLElBQU8sRUFBRSxXQUFXLFdBQVcsQ0FBQyxDQUFDO0FBQ2pDLElBQU8sU0FBUyxXQUFZLGFBQWEsQ0FBQyxDQUFDO0FBRTNDLEVBQUUsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO0FBSWhCOzs7Ozs7R0FNRztBQUNILDBCQUFrQyxNQUFnQixFQUFDLENBQVEsRUFBRSxDQUFRLEVBQUMsQ0FBUSxFQUFDLENBQVEsRUFBQyxDQUFRLEVBQUMsQ0FBUTtJQUNyR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFDdENBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLEdBQUNBLE1BQU1BLENB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LENBQUNBO2dCQUNMQSxDQUFDQSxDQUNKQSxDQUFBQTtZQUNMQSxDQUFDQTtZQUVERix3QkFBd0JBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFVBQVVBLEVBQUVBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLENBQUNBO1lBQ25FQSx3QkFBd0JBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFFBQVFBLEVBQUVBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQy9EQSw0QkFBNEJBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFVBQVVBLEVBQUVBLE1BQU1BLENBQUNBLFNBQVNBLEVBQUVBLE1BQU1BLENBQUNBLFVBQVVBLEVBQUVBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO1FBQ2pIQSxDQUFDQSxDQUFBQTtJQUNMQSxDQUFDQSxDQUNKQSxDQUFBQTtBQUNMQSxDQUFDQTtBQXhEZSxrQ0FBMEIsNkJBd0R6QyxDQUFBO0FBRUQ7SUFDSUcsc0JBQW1CQSxNQUFXQSxFQUFTQSxjQUF3QkEsRUFBU0EsV0FBcUJBO1FBQTFFQyxXQUFNQSxHQUFOQSxNQUFNQSxDQUFLQTtRQUFTQSxtQkFBY0EsR0FBZEEsY0FBY0EsQ0FBVUE7UUFBU0EsZ0JBQVdBLEdBQVhBLFdBQVdBLENBQVVBO0lBQUdBLENBQUNBO0lBQ3JHRCxtQkFBQ0E7QUFBREEsQ0FGQSxBQUVDQSxJQUFBO0FBRlksb0JBQVksZUFFeEIsQ0FBQSIsImZpbGUiOiJldmVudHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwZXMvY2FudmFzLmQudHNcIiAvPlxuaW1wb3J0IFJ4ID0gcmVxdWlyZShcInJ4XCIpO1xuaW1wb3J0IEF4ID0gcmVxdWlyZShcIi4vYW5pbWF4ZVwiKTtcbmltcG9ydCBQYXJhbWV0ZXIgPSByZXF1aXJlIChcIi4vcGFyYW1ldGVyXCIpO1xuXG5BeC5ERUJVRyA9IHRydWU7XG5cbmV4cG9ydCB0eXBlIFN5c3RlbU1vdXNlRXZlbnRzID0gQXguUG9pbnRbXTtcblxuLyoqXG4gKiBDb252ZXJ0IGFuaW1hdGlvbiBjb29yZGluYXRlcyAoZS5nLiBhIGNvb3JkaW5hdGUgb2YgbW92ZVRvKSB0byBnbG9iYWwgY2FudmFzIGNvb3JkaW5hdGVzLCBjb29lZmZlY2llbnRzIGFyZTpcbiAqIFsgYSBjIGVcbiAqICAgYiBkIGZcbiAqICAgMCAwIDEgXVxuICogVGhpcyBpcyBiYXNpY2FsbHkganVzdCBhIG1hdHJpeCBtdWx0aXBsaWNhdGlvbiBvZiB0aGUgY29udGV4dC50cmFuc2Zvcm1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGFuaW1hdGlvbjJDYW52YXMgKGNhbnZhczogQXguUG9pbnQsYTpudW1iZXIsIGI6bnVtYmVyLGM6bnVtYmVyLGQ6bnVtYmVyLGU6bnVtYmVyLGY6bnVtYmVyKTogQXguUG9pbnQge1xuICAgIHZhciB4ID0gYSpjYW52YXNbMF0gKyBjKmNhbnZhc1sxXSArIGU7XG4gICAgdmFyIHkgPSBiKmNhbnZhc1swXSArIGQqY2FudmFzWzFdICsgZjtcbiAgICByZXR1cm4gW3gseV07XG59XG4vKipcbiAqIENvbnZlcnQgY2FudmFzIGNvb3JkaW5hdGVzIChlLmcuIG1vdXNlIHBvc2l0aW9uIG9uIGNhbnZhcykgdG8gbG9jYWwgYW5pbWF0aW9uIGNvb3JkaW5hdGVzLCBjb29lZmZlY2llbnRzIGFyZTpcbiAqIFsgYSBjIGVcbiAqICAgYiBkIGZcbiAqICAgMCAwIDEgXVxuICogIFRoaXMgaXMgYmFzaWNhbGx5IGp1c3QgYW4gaW52ZXJzZSBtYXRyaXggbXVsdGlwbGljYXRpb24gb2YgdGhlIGNvbnRleHQudHJhbnNmb3JtXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjYW52YXMyQW5pbWF0aW9uIChjYW52YXNDb29yZDogQXguUG9pbnQsYTpudW1iZXIsIGI6bnVtYmVyLGM6bnVtYmVyLGQ6bnVtYmVyLGU6bnVtYmVyLGY6bnVtYmVyKTogQXguUG9pbnQge1xuICAgIC8vIHNlZSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzEwODkyMjY3L2h0bWw1LWNhbnZhcy10cmFuc2Zvcm1hdGlvbi1hbGdvcml0aG0tZmluZGluZy1vYmplY3QtY29vcmRpbmF0ZXMtYWZ0ZXItYXBwbHlpblxuICAgIHZhciBNID0gKGEqZCAtIGIqYyk7XG4gICAgcmV0dXJuIGFuaW1hdGlvbjJDYW52YXMoY2FudmFzQ29vcmQsIGQvTSwgLWIvTSwgLWMvTSwgYS9NLCAoYypmIC0gZCplKS9NLCAoYiplIC0gYSpmKS9NKVxufVxuXG5mdW5jdGlvbiBjYW52YXMyQW5pbWF0aW9uVXNpbmdDb250ZXh0IChjYW52YXNDb29yZDogQXguUG9pbnQsIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEKTogQXguUG9pbnQge1xuICAgIHZhciB0eCA9IGN0eC5nZXRUcmFuc2Zvcm0oKTtcbiAgICByZXR1cm4gY2FudmFzMkFuaW1hdGlvbihjYW52YXNDb29yZCwgdHhbMF0sIHR4WzFdLCB0eFszXSwgdHhbNF0sIHR4WzZdLCB0eFs3XSlcbn1cbi8qKlxuICogT2JqZWN0cyBvZiB0aGlzIHR5cGUgYXJlIHBhc3NlZCB0aHJvdWdoIHRoZSB0aWNrIHBpcGVsaW5lLCBhbmQgZW5jYXBzdWxhdGUgcG90ZW50aWFsbHkgbWFueSBjb25jdXJyZW50IHN5c3RlbSBldmVudHNcbiAqIG9yaWdpbmF0aW5nIGZyb20gdGhlIGNhbnZhcyBET00uIFRoZXNlIGhhdmUgdG8gYmUgaW50ZXByZXRlZCBieSBVSSBjb21wb25lbnRzIHRvIHNlZSBpZiB0aGV5IGhpdFxuICovXG5leHBvcnQgY2xhc3MgRXZlbnRzIHtcbiAgICBtb3VzZWRvd25zOiBTeXN0ZW1Nb3VzZUV2ZW50cyA9IFtdO1xuICAgIG1vdXNldXBzOiAgIFN5c3RlbU1vdXNlRXZlbnRzID0gW107XG4gICAgbW91c2Vtb3ZlczogU3lzdGVtTW91c2VFdmVudHMgPSBbXTtcbiAgICBtb3VzZWVudGVyczogU3lzdGVtTW91c2VFdmVudHMgPSBbXTtcbiAgICBtb3VzZWxlYXZlczogU3lzdGVtTW91c2VFdmVudHMgPSBbXTtcbiAgICAvL29ubW91c2VvdmVyOiBBeC5Qb2ludFtdID0gW107IHRvIGltcGxlbWVudCB0aGVzZSB3ZSBuZWVkIHRvIHRoaW5rIGFib3V0IGhlaXJhcmNoeSBpbiBjb21wb25lbnRzXG4gICAgLy9vbm1vdXNlb3V0OiBBeC5Qb2ludFtdID0gW107XG5cbiAgICAvKipcbiAgICAgKiBjbGVhciBhbGwgdGhlIGV2ZW50cywgZG9uZSBieSBhbmltYXRvciBhdCB0aGUgZW5kIG9mIGEgdGlja1xuICAgICAqL1xuICAgIGNsZWFyKCkge1xuICAgICAgICB0aGlzLm1vdXNlZG93bnMgPSBbXTtcbiAgICAgICAgdGhpcy5tb3VzZXVwcyAgID0gW107XG4gICAgICAgIHRoaXMubW91c2Vtb3ZlcyA9IFtdO1xuICAgICAgICB0aGlzLm1vdXNlZW50ZXJzID0gW107XG4gICAgICAgIHRoaXMubW91c2VsZWF2ZXMgPSBbXTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDb21wb25lbnRNb3VzZUV2ZW50cyB7XG4gICAgbW91c2Vkb3duICAgID0gbmV3IFJ4LlN1YmplY3Q8QXhNb3VzZUV2ZW50PigpO1xuICAgIG1vdXNldXAgICAgICA9IG5ldyBSeC5TdWJqZWN0PEF4TW91c2VFdmVudD4oKTtcbiAgICBtb3VzZW1vdmUgICAgPSBuZXcgUnguU3ViamVjdDxBeE1vdXNlRXZlbnQ+KCk7XG4gICAgbW91c2VlbnRlciAgID0gbmV3IFJ4LlN1YmplY3Q8QXhNb3VzZUV2ZW50PigpO1xuICAgIG1vdXNlbGVhdmUgICA9IG5ldyBSeC5TdWJqZWN0PEF4TW91c2VFdmVudD4oKTtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBzb3VyY2U6IGFueSkge31cblxuICAgIGlzTW91c2VPdmVyKCk6IEF4LlBhcmFtZXRlcjxib29sZWFuPiB7XG4gICAgICAgIHZhciB0b2dnbGU6IFJ4Lk9ic2VydmFibGU8Ym9vbGVhbj4gPVxuICAgICAgICAgICAgUnguT2JzZXJ2YWJsZS5tZXJnZShbXG4gICAgICAgICAgICAgICAgdGhpcy5tb3VzZWVudGVyLm1hcCgoeCkgPT4gdHJ1ZSksXG4gICAgICAgICAgICAgICAgdGhpcy5tb3VzZWxlYXZlLm1hcCgoeCkgPT4gZmFsc2UpXSk7XG4gICAgICAgIHJldHVybiBQYXJhbWV0ZXIudXBkYXRlRnJvbShmYWxzZSwgdG9nZ2xlKTtcbiAgICB9XG5cbiAgICBpc01vdXNlRG93bigpOiBBeC5QYXJhbWV0ZXI8Ym9vbGVhbj4ge1xuICAgICAgICB2YXIgbW91c2VEb3duOiBSeC5PYnNlcnZhYmxlPGJvb2xlYW4+ID1cbiAgICAgICAgICAgIFJ4Lk9ic2VydmFibGUubWVyZ2UoW1xuICAgICAgICAgICAgICAgIHRoaXMubW91c2Vkb3duLm1hcCgoeCkgID0+IHRydWUpLFxuICAgICAgICAgICAgICAgIHRoaXMubW91c2V1cC5tYXAoKHgpICAgID0+IGZhbHNlKSxcbiAgICAgICAgICAgICAgICB0aGlzLm1vdXNlbGVhdmUubWFwKCh4KSA9PiBmYWxzZSldKTtcbiAgICAgICAgcmV0dXJuIFBhcmFtZXRlci51cGRhdGVGcm9tKGZhbHNlLCBtb3VzZURvd24pO1xuICAgIH1cbn1cblxuLyoqXG4gKiByZXR1cm5zIGFuIGFuaW1hdGlvbiB0aGF0IGNhbiBiZSBwaXBlbGluZWQgYWZ0ZXIgYSBwYXRoLCB3aGljaCB1c2VkIGNhbnZhcyBpc1BvaW50SW5QYXRoIHRvIGRldGVjdCBpZiBhIG1vdXNlIGV2ZW50IGhhc1xuICogb2NjdXJlZCBvdmVyIHRoZSBzb3VyY2UgYW5pbWF0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBDb21wb25lbnRNb3VzZUV2ZW50SGFuZGxlcihldmVudHM6IENvbXBvbmVudE1vdXNlRXZlbnRzKTogQXguQW5pbWF0aW9uIHtcbiAgICByZXR1cm4gQXguZHJhdyhcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgdmFyIG1vdXNlSXNPdmVyID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm4gKHRpY2s6IEF4LlRpY2spID0+IHtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBwcm9jZXNzU3lzdGVtTW91c2VFdmVudHMoXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZUV2ZW50czogU3lzdGVtTW91c2VFdmVudHMsXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEV2ZW50U3RyZWFtOiBSeC5TdWJqZWN0PEF4TW91c2VFdmVudD5cbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlRXZlbnRzLmZvckVhY2goXG4gICAgICAgICAgICAgICAgICAgICAgICAoZXZ0OiBBeC5Qb2ludCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnRFdmVudFN0cmVhbS5oYXNPYnNlcnZlcnMoKSAmJiB0aWNrLmN0eC5pc1BvaW50SW5QYXRoKGV2dFswXSwgZXZ0WzFdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBoYXZlIHRvIGZpZ3VyZSBvdXQgdGhlIGdsb2JhbCBwb3NpdGlvbiBvZiB0aGlzIGNvbXBvbmVudCwgc28gdGhlIHggYW5kIHlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGF2ZSB0byBnbyBiYWNrd2FyZCB0aHJvdWdoIHRoZSB0cmFuc2Zvcm0gbWF0cml4XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbEV2ZW50ID0gbmV3IEF4TW91c2VFdmVudChldmVudHMuc291cmNlLCBjYW52YXMyQW5pbWF0aW9uVXNpbmdDb250ZXh0KGV2dCwgdGljay5jdHgpLCBldnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRFdmVudFN0cmVhbS5vbk5leHQobG9jYWxFdmVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc1N5c3RlbU1vdXNlTW92ZUV2ZW50cyhcbiAgICAgICAgICAgICAgICAgICAgc291cmNlTW92ZUV2ZW50czogU3lzdGVtTW91c2VFdmVudHMsXG4gICAgICAgICAgICAgICAgICAgIG1vdXNlbW92ZVN0cmVhbTogUnguU3ViamVjdDxBeE1vdXNlRXZlbnQ+LFxuICAgICAgICAgICAgICAgICAgICBtb3VzZWVudGVyU3RyZWFtOiBSeC5TdWJqZWN0PEF4TW91c2VFdmVudD4sXG4gICAgICAgICAgICAgICAgICAgIG1vdXNlbGVhdmVTdHJlYW06IFJ4LlN1YmplY3Q8QXhNb3VzZUV2ZW50PlxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBzb3VyY2VNb3ZlRXZlbnRzLmZvckVhY2goXG4gICAgICAgICAgICAgICAgICAgICAgICAoZXZ0OiBBeC5Qb2ludCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZW1vdmVTdHJlYW0uaGFzT2JzZXJ2ZXJzKCkgfHwgbW91c2VlbnRlclN0cmVhbS5oYXNPYnNlcnZlcnMoKSB8fCBtb3VzZWxlYXZlU3RyZWFtLmhhc09ic2VydmVycygpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb2ludEluUGF0aCA9IHRpY2suY3R4LmlzUG9pbnRJblBhdGgoZXZ0WzBdLCBldnRbMV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9jYWxFdmVudCA9IG5ldyBBeE1vdXNlRXZlbnQoZXZlbnRzLnNvdXJjZSwgY2FudmFzMkFuaW1hdGlvblVzaW5nQ29udGV4dChldnQsIHRpY2suY3R4KSwgZXZ0KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW91c2VlbnRlclN0cmVhbS5oYXNPYnNlcnZlcnMoKSAmJiBwb2ludEluUGF0aCAmJiAhbW91c2VJc092ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlZW50ZXJTdHJlYW0ub25OZXh0KGxvY2FsRXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZW1vdmVTdHJlYW0uaGFzT2JzZXJ2ZXJzKCkgJiYgcG9pbnRJblBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlbW92ZVN0cmVhbS5vbk5leHQobG9jYWxFdmVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW91c2VsZWF2ZVN0cmVhbS5oYXNPYnNlcnZlcnMoKSAmJiAhcG9pbnRJblBhdGggJiYgbW91c2VJc092ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlbGVhdmVTdHJlYW0ub25OZXh0KGxvY2FsRXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW91c2VJc092ZXIgPSBwb2ludEluUGF0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBwcm9jZXNzU3lzdGVtTW91c2VFdmVudHModGljay5ldmVudHMubW91c2Vkb3ducywgZXZlbnRzLm1vdXNlZG93bik7XG4gICAgICAgICAgICAgICAgcHJvY2Vzc1N5c3RlbU1vdXNlRXZlbnRzKHRpY2suZXZlbnRzLm1vdXNldXBzLCBldmVudHMubW91c2V1cCk7XG4gICAgICAgICAgICAgICAgcHJvY2Vzc1N5c3RlbU1vdXNlTW92ZUV2ZW50cyh0aWNrLmV2ZW50cy5tb3VzZW1vdmVzLCBldmVudHMubW91c2Vtb3ZlLCBldmVudHMubW91c2VlbnRlciwgZXZlbnRzLm1vdXNlbGVhdmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgKVxufVxuXG5leHBvcnQgY2xhc3MgQXhNb3VzZUV2ZW50IHtcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgc291cmNlOiBhbnksIHB1YmxpYyBhbmltYXRpb25Db29yZDogQXguUG9pbnQsIHB1YmxpYyBjYW52YXNDb29yZDogQXguUG9pbnQpIHt9XG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
